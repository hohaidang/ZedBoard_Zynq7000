/* Project nay dung UART de send len putty hoac terminal vitis thong qua cong
   USB cam vao board va control LED thong qua bo Axi GPIO duoc tao ra trong
   vivado
  */
#include "xil_printf.h"
#include "xparameters.h"
#include "xuartps.h"
#include "xgpiops.h"
#include "xstatus.h"
#include <array>

#define UART_DEVICE_ID XPAR_XUARTPS_0_DEVICE_ID
// #define GPIO_EXAMPLE_DEVICE_ID XPAR_GPIO_0_DEVICE_ID
#define LED_CHANNEL 1
#define LED_DELAY 10000000
 #define PIN_OFFSET 54 // [0:53] is MIO pins, so EMIO from 54

XUartPs Uart_PS;
XGpioPs Gpio;
XGpioPs_Config *ConfigPtr;
int Status;

void uart_control() {

  XUartPs_Config *Config;
  std::array<u8, 50> sendBuffer = {};
  char data[] = "DANG This is my UART Sending\n";

  memcpy(sendBuffer.begin(), data, strlen(data));
  int Status;

  Config = XUartPs_LookupConfig(UART_DEVICE_ID);
  if (NULL == Config) {
    xil_printf("Config Failed");
  }
  Status = XUartPs_CfgInitialize(&Uart_PS, Config, Config->BaseAddress);
  if (Status != XST_SUCCESS) {
    xil_printf("Initialization Failed");
  }

  Status = XUartPs_SelfTest(&Uart_PS);
  if (Status != XST_SUCCESS) {
    xil_printf("Self Test Failed");
  }
  XUartPs_SetOperMode(&Uart_PS, XUARTPS_OPER_MODE_NORMAL);

  XUartPs_Send(&Uart_PS, sendBuffer.begin(), sendBuffer.size());
//  while (XUartPs_IsSending(&Uart_PS))
//    ;
}

void gpio_control() {
  ConfigPtr = XGpioPs_LookupConfig(XPAR_XGPIOPS_0_DEVICE_ID);
  Status = XGpioPs_CfgInitialize(&Gpio, ConfigPtr, ConfigPtr->BaseAddr);
  if(Status != XST_SUCCESS) {
    xil_printf("GPIO Initialize failed");
    return;
  }
  XGpioPs_SetDirectionPin(&Gpio, PIN_OFFSET, 1);
  XGpioPs_SetOutputEnablePin(&Gpio, PIN_OFFSET, 1);
  XGpioPs_WritePin(&Gpio, PIN_OFFSET, 1);
}

int main(void) {
  uart_control();
  gpio_control();
  return 0;
}
